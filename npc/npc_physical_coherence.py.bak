"""
NPC Physical Coherence Module - ç‰©ç†åŸºå±¤ãƒ¬ãƒ™ãƒ«ã®æ•´åˆæ…£æ€§ã‚·ã‚¹ãƒ†ãƒ 
ç”Ÿå­˜æ¬²æ±‚ï¼ˆæ¸‡æ°´ãƒ»é£¢é¤“ï¼‰ã‚’æ•´åˆæ…£æ€§Îºã¨ã—ã¦çµ±åˆå®Ÿè£…
"""

import sys
import os
from collections import defaultdict

# è¦ªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ãƒ‘ã‚¹ã«è¿½åŠ 
sys.path.append(os.path.dirname(os.path.dirname(__file__)))

from config import DEFAULT_KAPPA
from utils import log_event


class NPCPhysicalCoherenceMixin:
    """ç‰©ç†åŸºå±¤ãƒ¬ãƒ™ãƒ«ã®æ•´åˆæ…£æ€§ãƒŸãƒƒã‚¯ã‚¹ã‚¤ãƒ³"""
    
    def __init_physical_coherence__(self):
        """ç‰©ç†æ•´åˆæ…£æ€§ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–"""
        # ç‰©ç†åŸºå±¤æ•´åˆæ…£æ€§ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
        self.physical_kappa = defaultdict(lambda: DEFAULT_KAPPA)
        
        # ç”Ÿå­˜æ•´åˆæ…£æ€§ã®åˆæœŸå€¤è¨­å®šï¼ˆç”Ÿå­˜åŠ¹ç‡é‡è¦–ï¼‰
        self.physical_kappa["thirst_coherence"] = 0.7  # è„±æ°´é˜²æ­¢ã‚’æœ€å„ªå…ˆ
        self.physical_kappa["hunger_coherence"] = 0.6  # é£¢é¤“é˜²æ­¢ã‚‚å¼·åŒ–
        self.physical_kappa["fatigue_coherence"] = 0.4  # ç–²åŠ´ç®¡ç†ã‚‚é‡è¦
        self.physical_kappa["territory_coherence"] = 0.5  # ç¸„å¼µã‚Šæ•´åˆæ€§å‘ä¸Š
        self.physical_kappa["hunting_coherence"] = 0.7  # ç‹©ã‚Šæ•´åˆæ…£æ€§ï¼ˆãƒ†ã‚¹ãƒˆå¼·åŒ–ç‰ˆï¼‰
        
        # ç‰©ç†åŸºå±¤å‹•æ…‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
        self.coherence_pressure = 0.0  # æ•´åˆåœ§åŠ›
        self.physical_tension = 0.0    # ç‰©ç†çš„ç·Šå¼µåº¦
        self.survival_resonance = 1.0  # ç”Ÿå­˜å…±é³´åº¦
        
        # ç¸„å¼µã‚Šã¨ã®æ•´åˆæ€§
        self.territory_coherence_factor = 1.0
        self.resource_coherence_map = {}  # ãƒªã‚½ãƒ¼ã‚¹ä½ç½®ã¨ã®æ•´åˆæ€§ãƒãƒƒãƒ—
        
    def update_physical_coherence(self, t):
        """ç‰©ç†åŸºå±¤æ•´åˆæ…£æ€§ã®æ›´æ–°"""
        # 1. ç”Ÿå­˜çŠ¶æ…‹ã«ã‚ˆã‚‹æ•´åˆæ…£æ€§ã®è¨ˆç®—
        self._calculate_survival_coherence()
        
        # 2. ç¸„å¼µã‚Šã¨ã®æ•´åˆæ€§è©•ä¾¡
        self._evaluate_territory_coherence()
        
        # 3. ç‰©ç†çš„ç·Šå¼µåº¦ã®æ›´æ–°
        self._update_physical_tension()
        
        # 4. æ•´åˆåœ§åŠ›ã®è¨ˆç®—
        self._calculate_coherence_pressure()
        
        # 5. ç”Ÿå­˜å…±é³´åº¦ã®æ›´æ–°
        self._update_survival_resonance()
        
        # ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
        if self.coherence_pressure > 0.3 or self.physical_tension > 0.5:
            print(f"ğŸ§¬ T{t}: {self.name} ç‰©ç†æ•´åˆ - åœ§åŠ›:{self.coherence_pressure:.2f} ç·Šå¼µ:{self.physical_tension:.2f} å…±é³´:{self.survival_resonance:.2f}")
        
    def _calculate_survival_coherence(self):
        """ç”Ÿå­˜çŠ¶æ…‹ã«ã‚ˆã‚‹æ•´åˆæ…£æ€§ã®è¨ˆç®—ï¼ˆç”Ÿå­˜åŠ¹ç‡å¼·åŒ–ç‰ˆï¼‰"""
        # æ¸‡æ°´æ•´åˆæ…£æ€§ - æ—©æœŸã‹ã‚‰å¼·åŠ›ã«åå¿œ
        if self.thirst > 60:  # é–¾å€¤ã‚’ä¸‹ã’ã¦æ—©æœŸå¯¾å¿œ
            thirst_intensity = min(1.0, self.thirst / 80.0)  # ã‚ˆã‚Šæ—©æœŸã«æœ€å¤§å¼·åº¦
            boost = 0.12 if self.thirst > 85 else 0.08  # ç·Šæ€¥æ™‚ã®å¤§å¹…å¼·åŒ–
            self.physical_kappa["thirst_coherence"] = min(1.0, 
                self.physical_kappa["thirst_coherence"] + thirst_intensity * boost)
        
        # é£¢é¤“æ•´åˆæ…£æ€§ - æ—©æœŸã‹ã‚‰å¼·åŠ›ã«åå¿œ
        if self.hunger > 60:  # é–¾å€¤ã‚’ä¸‹ã’ã¦æ—©æœŸå¯¾å¿œ
            hunger_intensity = min(1.0, self.hunger / 90.0)  # ã‚ˆã‚Šæ—©æœŸã«æœ€å¤§å¼·åº¦
            boost = 0.10 if self.hunger > 95 else 0.06  # ç·Šæ€¥æ™‚ã®å¤§å¹…å¼·åŒ–
            self.physical_kappa["hunger_coherence"] = min(1.0,
                self.physical_kappa["hunger_coherence"] + hunger_intensity * boost)
        
        # ç–²åŠ´æ•´åˆæ…£æ€§ - ç–²åŠ´æ™‚ã®ä¼‘æ¯å ´æ‰€ã¨ã®æ•´åˆæ€§
        if hasattr(self, 'fatigue') and self.fatigue > 70:
            fatigue_intensity = min(1.0, self.fatigue / 100.0)
            boost = 0.06 if self.fatigue > 110 else 0.04
            self.physical_kappa["fatigue_coherence"] = min(1.0,
                self.physical_kappa["fatigue_coherence"] + fatigue_intensity * boost)
        
        # ç‹©ã‚Šæ•´åˆæ…£æ€§ - ç‹©ã‚ŠæˆåŠŸãƒ»å¤±æ•—ã«ã‚ˆã‚‹å‹•çš„èª¿æ•´
        if hasattr(self, 'hunt_success_count') and hasattr(self, 'hunt_failure_count'):
            total_hunts = self.hunt_success_count + self.hunt_failure_count
            if total_hunts > 0:
                success_rate = self.hunt_success_count / total_hunts
                # æˆåŠŸç‡ã«å¿œã˜ã¦ç‹©ã‚Šæ•´åˆæ…£æ€§ã‚’èª¿æ•´
                if success_rate > 0.6:  # é«˜æˆåŠŸç‡
                    self.physical_kappa["hunting_coherence"] = min(0.9, 
                        self.physical_kappa["hunting_coherence"] + 0.02)
                elif success_rate < 0.3:  # ä½æˆåŠŸç‡
                    self.physical_kappa["hunting_coherence"] = max(0.1,
                        self.physical_kappa["hunting_coherence"] - 0.01)
        
        # æ•´åˆæ…£æ€§ã®è‡ªç„¶æ¸›è¡°ã‚’ç·©å’Œï¼ˆç”Ÿå­˜é‡è¦–ï¼‰
        for key in ["thirst_coherence", "hunger_coherence", "fatigue_coherence", "hunting_coherence"]:
            decay = 0.003 if self.physical_kappa[key] > 0.8 else 0.006  # é«˜ãƒ¬ãƒ™ãƒ«ã§ã¯æ¸›è¡°ã‚’æŠ‘åˆ¶
            min_value = 0.3 if key != "hunting_coherence" else 0.1  # ç‹©ã‚Šã¯æœ€å°å€¤ã‚’ä½ã
            self.physical_kappa[key] = max(min_value, self.physical_kappa[key] - decay)
    
    def _evaluate_territory_coherence(self):
        """ç¸„å¼µã‚Šã¨ã®æ•´åˆæ€§è©•ä¾¡"""
        if not hasattr(self, 'territory') or not self.territory:
            self.territory_coherence_factor = 0.5  # ç¸„å¼µã‚Šãªã—ã¯ä½æ•´åˆæ€§
            return
        
        # ç¾åœ¨åœ°ã¨ç¸„å¼µã‚Šä¸­å¿ƒã®è·é›¢ã«åŸºã¥ãæ•´åˆæ€§
        if hasattr(self.territory, 'center'):
            distance_to_center = self.distance_to(self.territory.center)
            territory_radius = getattr(self.territory, 'radius', 15)
            
            # ç¸„å¼µã‚Šå†…ã§ã®æ•´åˆæ€§ã¯é«˜ã„
            if distance_to_center <= territory_radius:
                self.territory_coherence_factor = min(1.5, 1.0 + (territory_radius - distance_to_center) / territory_radius * 0.5)
            else:
                # ç¸„å¼µã‚Šå¤–ã§ã¯æ•´åˆæ€§ãŒä½ä¸‹
                self.territory_coherence_factor = max(0.3, 1.0 - (distance_to_center - territory_radius) / territory_radius * 0.3)
        
        # ç¸„å¼µã‚Šæ•´åˆæ…£æ€§ã®æ›´æ–°
        coherence_change = (self.territory_coherence_factor - 1.0) * 0.02
        self.physical_kappa["territory_coherence"] = min(1.0, max(0.1,
            self.physical_kappa["territory_coherence"] + coherence_change))
    
    def _update_physical_tension(self):
        """ç‰©ç†çš„ç·Šå¼µåº¦ã®æ›´æ–°"""
        # ç”Ÿå­˜æ¬²æ±‚ã«ã‚ˆã‚‹ç·Šå¼µ
        survival_tension = (
            min(1.0, self.thirst / 120.0) * 0.4 +
            min(1.0, self.hunger / 150.0) * 0.3 +
            (min(1.0, getattr(self, 'fatigue', 0) / 120.0) * 0.2)
        )
        
        # ç¸„å¼µã‚Šä¸æ•´åˆã«ã‚ˆã‚‹ç·Šå¼µ
        territory_tension = max(0, 1.0 - self.territory_coherence_factor) * 0.3
        
        # æ•´åˆæ…£æ€§ä¸è¶³ã«ã‚ˆã‚‹ç·Šå¼µ
        coherence_deficit = 1.0 - (
            self.physical_kappa["thirst_coherence"] +
            self.physical_kappa["hunger_coherence"] +
            self.physical_kappa["territory_coherence"] +
            self.physical_kappa["hunting_coherence"]
        ) / 4.0
        coherence_tension = max(0, coherence_deficit) * 0.2
        
        self.physical_tension = min(1.0, survival_tension + territory_tension + coherence_tension)
    
    def _calculate_coherence_pressure(self):
        """æ•´åˆåœ§åŠ›ã®è¨ˆç®—"""
        # ç‰©ç†çš„ç·Šå¼µåº¦ã‹ã‚‰æ•´åˆåœ§åŠ›ã‚’ç”Ÿæˆ
        base_pressure = self.physical_tension
        
        # è¤‡æ•°è¦å› ã®ç›¸äº’ä½œç”¨ã«ã‚ˆã‚‹åœ§åŠ›å¢—å¹…
        interaction_factor = 1.0
        active_tensions = 0
        
        if self.thirst > 60:
            active_tensions += 1
        if self.hunger > 70:
            active_tensions += 1
        if hasattr(self, 'fatigue') and self.fatigue > 90:
            active_tensions += 1
        if self.territory_coherence_factor < 0.7:
            active_tensions += 1
        
        if active_tensions >= 2:
            interaction_factor = 1.0 + (active_tensions - 1) * 0.3
        
        self.coherence_pressure = min(1.0, base_pressure * interaction_factor)
    
    def _update_survival_resonance(self):
        """ç”Ÿå­˜å…±é³´åº¦ã®æ›´æ–°"""
        # æ•´åˆæ…£æ€§ãŒé«˜ã„ã»ã©å…±é³´åº¦ãŒå‘ä¸Š
        average_coherence = (
            self.physical_kappa["thirst_coherence"] +
            self.physical_kappa["hunger_coherence"] +
            self.physical_kappa["territory_coherence"] +
            self.physical_kappa["hunting_coherence"]
        ) / 4.0
        
        # åœ§åŠ›ãŒé©åº¦ãªæ™‚ã«æœ€å¤§å…±é³´
        pressure_factor = 1.0 - abs(self.coherence_pressure - 0.3) * 2.0
        pressure_factor = max(0.2, pressure_factor)
        
        self.survival_resonance = average_coherence * pressure_factor
    
    def get_coherence_driven_behavior_priority(self):
        """æ•´åˆæ…£æ€§ã«åŸºã¥ãè¡Œå‹•å„ªå…ˆåº¦ã®å–å¾—"""
        priorities = {}
        
        # æ¸‡æ°´æ•´åˆæ…£æ€§ã«ã‚ˆã‚‹æ°´æºæ¢ç´¢å„ªå…ˆåº¦ï¼ˆç”Ÿå­˜é‡è¦–ï¼‰
        if self.physical_kappa["thirst_coherence"] > 0.3:  # é–¾å€¤ã‚’ä¸‹ã’ã¦æ—©æœŸç™ºå‹•
            urgency_factor = min(2.0, self.thirst / 60.0)  # ã‚ˆã‚Šæ—©æœŸã«é«˜å„ªå…ˆåº¦
            water_priority = self.physical_kappa["thirst_coherence"] * urgency_factor
            priorities["seek_water"] = min(1.0, water_priority)
        
        # é£¢é¤“æ•´åˆæ…£æ€§ã«ã‚ˆã‚‹é£Ÿæ–™æ¢ç´¢å„ªå…ˆåº¦ï¼ˆç”Ÿå­˜é‡è¦–ï¼‰
        if self.physical_kappa["hunger_coherence"] > 0.3:  # é–¾å€¤ã‚’ä¸‹ã’ã¦æ—©æœŸç™ºå‹•
            urgency_factor = min(2.0, self.hunger / 70.0)  # ã‚ˆã‚Šæ—©æœŸã«é«˜å„ªå…ˆåº¦
            food_priority = self.physical_kappa["hunger_coherence"] * urgency_factor
            priorities["seek_food"] = min(1.0, food_priority)
        
        # ç¸„å¼µã‚Šæ•´åˆæ…£æ€§ã«ã‚ˆã‚‹ç¸„å¼µã‚Šè¡Œå‹•å„ªå…ˆåº¦
        if self.physical_kappa["territory_coherence"] > 0.3:
            if self.territory_coherence_factor < 0.8:
                # ç¸„å¼µã‚Šå¤–ã«ã„ã‚‹å ´åˆã¯æˆ»ã‚‹å„ªå…ˆåº¦ãŒé«˜ã„
                priorities["return_to_territory"] = min(1.0, 
                    self.physical_kappa["territory_coherence"] * (1.0 - self.territory_coherence_factor))
            else:
                # ç¸„å¼µã‚Šå†…ã§ã¯å¼·åŒ–ãƒ»é˜²è¡›ã®å„ªå…ˆåº¦
                priorities["strengthen_territory"] = min(0.5,
                    self.physical_kappa["territory_coherence"] * self.territory_coherence_factor * 0.3)
        
        # ç‹©ã‚Šæ•´åˆæ…£æ€§ã«ã‚ˆã‚‹ç‹©ã‚Šè¡Œå‹•å„ªå…ˆåº¦ï¼ˆå¼·åˆ¶ãƒ‡ãƒãƒƒã‚°ç‰ˆï¼‰
        hunting_coherence = self.physical_kappa["hunting_coherence"]
        hunt_need_factor = min(2.5, self.hunger / 50.0)  # ã‚ˆã‚Šæ—©æœŸã«ç‹©ã‚Šãƒ‹ãƒ¼ã‚ºãŒç™ºç”Ÿ
        skill_factor = max(0.5, getattr(self, 'hunting_skill', 0.3))  # æœ€ä½ã‚¹ã‚­ãƒ«ã‚’ä¿è¨¼
        
        # å¼·åˆ¶çš„ã«ç‹©ã‚Šå„ªå…ˆåº¦ã‚’è¨ˆç®—ï¼ˆãƒ‡ãƒãƒƒã‚°ï¼‰
        hunt_priority = hunting_coherence * hunt_need_factor * skill_factor * 1.5
        priorities["hunt"] = min(1.0, hunt_priority)
        
        # ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›ï¼ˆå¸¸ã«è¡¨ç¤ºï¼‰
        print(f"DEBUG_HUNT: {getattr(self, 'name', 'Unknown')} coherence:{hunting_coherence:.2f} need:{hunt_need_factor:.2f} skill:{skill_factor:.2f} priority:{hunt_priority:.3f}")
        
        return priorities
    
    def apply_coherence_to_movement(self, target, base_speed=2):
        """æ•´åˆæ…£æ€§ã‚’è€ƒæ…®ã—ãŸç§»å‹•èª¿æ•´ï¼ˆç”Ÿå­˜é‡è¦–å¼·åŒ–ç‰ˆï¼‰"""
        # æ•´åˆæ…£æ€§ãƒ¬ãƒ™ãƒ«ãŒé«˜ã„ã»ã©ç§»å‹•åŠ¹ç‡å‘ä¸Šï¼ˆç”Ÿå­˜é‡è¦–ï¼‰
        coherence_bonus = (
            self.physical_kappa["thirst_coherence"] * 0.8 +  # æ°´æºæ¢ç´¢ã‚’æœ€å„ªå…ˆ
            self.physical_kappa["hunger_coherence"] * 0.6 +  # é£Ÿæ–™æ¢ç´¢ã‚‚å¼·åŒ–
            self.physical_kappa["territory_coherence"] * 0.3
        )
        
        # ç‰©ç†çš„ç·Šå¼µåº¦ã«ã‚ˆã‚‹ç·Šæ€¥æ™‚é€Ÿåº¦å¤§å¹…å‘ä¸Š
        tension_factor = 1.0 + self.physical_tension * 1.5  # ç·Šæ€¥æ™‚ã®é€Ÿåº¦å‘ä¸Šã‚’å€å¢—
        
        # ç”Ÿå­˜å±æ©Ÿæ™‚ã®ç‰¹åˆ¥ãƒœãƒ¼ãƒŠã‚¹
        crisis_bonus = 1.0
        if self.thirst > 80 or self.hunger > 90:
            crisis_bonus = 2.2  # å±æ©Ÿæ™‚ã¯å¤§å¹…é€Ÿåº¦å‘ä¸Š
        elif self.thirst > 65 or self.hunger > 75:
            crisis_bonus = 1.6  # æº–å±æ©Ÿæ™‚ã‚‚é€Ÿåº¦å‘ä¸Š
        
        # æ•´åˆåœ§åŠ›ã«ã‚ˆã‚‹è¿½åŠ ãƒœãƒ¼ãƒŠã‚¹
        pressure_boost = 1.0 + self.coherence_pressure * 0.8
        
        adjusted_speed = base_speed * (1.0 + coherence_bonus) * tension_factor * crisis_bonus * pressure_boost
        return min(6, int(adjusted_speed))  # æœ€å¤§6å€ã¾ã§å‘ä¸Š
    
    def get_physical_coherence_state(self):
        """ç‰©ç†æ•´åˆæ…£æ€§çŠ¶æ…‹ã®å–å¾—ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰"""
        return {
            "physical_kappa": dict(self.physical_kappa),
            "coherence_pressure": self.coherence_pressure,
            "physical_tension": self.physical_tension,
            "survival_resonance": self.survival_resonance,
            "territory_coherence_factor": self.territory_coherence_factor
        }